<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>WebGIS Yol Sorun Bildirim Sistemi</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body { margin: 0; font-family: Arial; }

    #loginBox {
      width: 320px;
      margin: 100px auto;
      text-align: center;
    }

    #map {
      height: 100vh;
      display: none;
    }

    input, button {
      width: 100%;
      padding: 8px;
      margin-top: 8px;
    }

    .link {
      color: blue;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>

<!-- ================= LOGIN ================= -->
<div id="loginBox">
  <h2 id="formTitle">Giriş Yap</h2>

  <input id="username" placeholder="Kullanıcı adı">
  <input id="password" type="password" placeholder="Şifre">

  <button onclick="login()">Giriş Yap</button>

  <p class="link" onclick="showRegister()">Vatandaş olarak kayıt ol</p>
</div>

<!-- ================= MAP ================= -->
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const API = "http://localhost:3000";
let map;
let isRegister = false;

/* ================= FORM TOGGLE ================= */
function showRegister() {
  document.getElementById("formTitle").innerText = "Vatandaş Kaydı";
  document.querySelector("button").innerText = "Kayıt Ol";
  document.querySelector(".link").style.display = "none";
  isRegister = true;
}

/* ================= LOGIN / REGISTER ================= */
function login() {
  if (isRegister) {
    register();
    return;
  }

  fetch(API + "/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: username.value,
      password: password.value
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }

    localStorage.setItem("token", data.token);
    localStorage.setItem("role", data.role);

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("map").style.display = "block";

    initMap();
  });
}

/* ================= REGISTER (ONLY USER) ================= */
function register() {
  fetch(API + "/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: username.value,
      password: password.value,
      role: "user"
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }

    alert("Kayıt başarılı, giriş yapabilirsiniz");
    location.reload();
  });
}

/* ================= MAP ================= */
function initMap() {
  map = L.map("map").setView([39.998, 32.865], 14);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
    .addTo(map);

  loadReports();
  map.on("click", onMapClick);
}

/* ================= LOAD REPORTS ================= */
function loadReports() {
  fetch(API + "/reports", {
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token")
    }
  })
  .then(res => res.json())
  .then(data => {
    const role = localStorage.getItem("role");

    data.forEach(r => {
      const g = JSON.parse(r.geom);

      let popup = `
        <b>Tür:</b> ${r.type}<br>
        <b>Durum:</b> ${r.status}<br>
        <b>Ekip:</b> ${r.assigned_team || "Atanmadı"}<br>
      `;

      if (role === "worker") {
        popup += `
          <button onclick="updateStatus(${r.id}, 'tamir edilecek')">Tamir Edilecek</button>
          <button onclick="updateStatus(${r.id}, 'tamir edildi')">Tamir Edildi</button>
        `;
      }

      if (role === "manager") {
        popup += `<button onclick="assignTeam(${r.id})">Ekip Ata</button>`;
      }

      L.marker([g.coordinates[1], g.coordinates[0]])
        .bindPopup(popup)
        .addTo(map);
    });
  });
}

/* ================= ADD REPORT (USER) ================= */
function onMapClick(e) {
  if (localStorage.getItem("role") !== "user") return;

  const type = prompt("Sorun türü (pothole / sidewalk)");
  if (!type) return;

  fetch(API + "/reports", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.getItem("token")
    },
    body: JSON.stringify({
      type,
      lat: e.latlng.lat,
      lng: e.latlng.lng
    })
  }).then(() => location.reload());
}

/* ================= WORKER ================= */
function updateStatus(id, status) {
  fetch(API + `/reports/${id}/status`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.getItem("token")
    },
    body: JSON.stringify({ status })
  }).then(() => location.reload());
}

/* ================= MANAGER ================= */
function assignTeam(id) {
  const team = prompt("Ekip adı giriniz");
  if (!team) return;

  fetch(API + `/reports/${id}/assign`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.getItem("token")
    },
    body: JSON.stringify({ team })
  }).then(() => location.reload());
}
</script>

</body>
</html>
