<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>WebGIS Belediye Sistemi</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: url('keÃ§iÃ¶ren.jpg') no-repeat center center fixed; /* GÃ¶rseli ekliyoruz */
      background-size: cover;
    }

    #map {
      height: 100vh;
    }

    #loginBox, #panel, #teamPanel {
      position: absolute;
      background: white;
      padding: 10px;
      z-index: 1000;
      border-radius: 6px;
    }

    #loginBox {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 260px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    #panel {
      top: 20px;
      right: 20px;
      width: 250px;
      display: none;
    }

    #teamPanel {
      bottom: 20px;
      right: 20px;
      width: 220px;
      display: none;
    }

    button {
      width: 100%;
      margin-top: 5px;
    }

    select, input {
      width: 100%;
      margin-top: 5px;
    }
  </style>
</head>

<body>

<div id="loginBox">
  <h3>GiriÅŸ</h3>
  <input id="username" placeholder="KullanÄ±cÄ± adÄ±">
  <input id="password" type="password" placeholder="Åžifre">
  <button onclick="login()">GiriÅŸ Yap</button>

  <hr>
  <h4>KullanÄ±cÄ± KayÄ±t</h4>
  <input id="r_user" placeholder="KullanÄ±cÄ± adÄ±">
  <input id="r_pass" type="password" placeholder="Åžifre">
  <button onclick="register()">KayÄ±t Ol</button>
</div>

<div id="panel">
  <h3 id="roleTitle"></h3>
  <div id="managerControls"></div>
  <div id="workerControls"></div>
</div>

<div id="teamPanel">
  <h4>Ekip DurumlarÄ±</h4>
  <ul id="teamList"></ul>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API = "http://localhost:3000";
let map;
let role = null;

/* ================= MAP ================= */

function initMap() {
  map = L.map("map").setView([39.983, 32.866], 13); // KeÃ§iÃ¶ren

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap"
  }).addTo(map);

  map.on("click", onMapClick);
  loadReports();
}

/* ================= AUTH ================= */

function login() {
  fetch(API + "/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: username.value,
      password: password.value
    })
  })
  .then(r => r.json())
  .then(d => {
    if (d.token) {
      localStorage.token = d.token;
      localStorage.role = d.role;
      role = d.role;
      loginBox.style.display = "none";
      panel.style.display = "block";
      roleTitle.innerText = "Rol: " + role;
      initRoleUI();
      initMap();
    } else alert(d.error);
  });
}

function register() {
  fetch(API + "/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: r_user.value,
      password: r_pass.value,
      role: "user"
    })
  })
  .then(r => r.json())
  .then(d => alert(d.message || d.error));
}

/* ================= ROLE UI ================= */

function initRoleUI() {
  if (role === "manager") {
    teamPanel.style.display = "block";
    loadTeams();
  }

  if (role === "worker") {
    workerControls.innerHTML = `
      <select id="statusSelect">
        <option value="tamir edilecek">Tamir Edilecek</option>
        <option value="tamir edildi">Tamir Edildi</option>
      </select>
    `;
  }
}

/* ================= MAP CLICK ================= */

function onMapClick(e) {
  if (role !== "user") return;

  const desc = prompt("Sorun aÃ§Ä±klamasÄ±:");
  if (!desc) return;

  fetch(API + "/reports", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.token
    },
    body: JSON.stringify({
      type: "yol",
      description: desc,
      lat: e.latlng.lat,
      lng: e.latlng.lng
    })
  }).then(() => loadReports());
}

/* ================= LOAD REPORTS ================= */

function loadReports() {
  fetch(API + "/reports", {
    headers: { Authorization: "Bearer " + localStorage.token }
  })
  .then(r => r.json())
  .then(data => {
    data.forEach(r => {
      const g = JSON.parse(r.geom);
      const m = L.marker([g.coordinates[1], g.coordinates[0]]).addTo(map);

      let html = `<b>${r.description}</b><br>Durum: ${r.status}`;

      if (role === "manager") {
        html += `
          <br>
          <select onchange="assignTeam(${r.id}, this.value)">
            <option>-- ekip seÃ§ --</option>
            <option>Ekip 1</option>
            <option>Ekip 2</option>
            <option>Ekip 3</option>
          </select>
        `;
      }

      if (role === "worker") {
        html += `
          <br>
          <button onclick="updateStatus(${r.id}, 'tamir edildi')">
            Tamir Edildi
          </button>
        `;
      }

      m.bindPopup(html);
    });
  });
}

/* ================= MANAGER ================= */

function assignTeam(id, team) {
  fetch(API + `/reports/${id}/assign`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.token
    },
    body: JSON.stringify({ team })
  }).then(() => loadTeams());
}

function loadTeams() {
  fetch(API + "/teams", {
    headers: { Authorization: "Bearer " + localStorage.token }
  })
  .then(r => r.json())
  .then(data => {
    teamList.innerHTML = "";
    data.forEach(t => {
      const icon = t.status === "available" ? "ðŸŸ¢" : "ðŸ”´";
      teamList.innerHTML += `<li>${icon} ${t.name}</li>`;
    });
  });
}

/* ================= WORKER ================= */

function updateStatus(id, status) {
  fetch(API + `/reports/${id}/status`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.token
    },
    body: JSON.stringify({ status })
  }).then(() => location.reload());
}
</script>

</body>
</html>