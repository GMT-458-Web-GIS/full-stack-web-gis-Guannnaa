<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>WebGIS Yol Sorun Bildirim Sistemi</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #loginBox {
      width: 300px;
      margin: 120px auto;
      text-align: center;
    }

    #map {
      height: 100vh;
      display: none;
    }

    input, button {
      width: 100%;
      padding: 8px;
      margin-top: 8px;
    }

    button {
      cursor: pointer;
    }
  </style>
</head>
<body>

<!-- ================= LOGIN ================= -->
<div id="loginBox">
  <h2>KullanÄ±cÄ± GiriÅŸi</h2>
  <input id="username" placeholder="KullanÄ±cÄ± adÄ±">
  <input id="password" type="password" placeholder="Åifre">
  <button onclick="login()">GiriÅŸ Yap</button>
</div>

<!-- ================= MAP ================= -->
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const API = "http://localhost:3000";
let map;

/* ================= LOGIN ================= */
function login() {
  fetch(API + "/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: username.value,
      password: password.value
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }

    // ğŸ” Token + role sakla
    localStorage.setItem("token", data.token);
    localStorage.setItem("role", data.role);

    // UI geÃ§iÅŸ
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("map").style.display = "block";

    initMap();
  });
}

/* ================= MAP INIT ================= */
function initMap() {
  // ğŸ“ Ankara KeÃ§iÃ¶ren
  map = L.map("map").setView([39.998, 32.865], 14);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
    .addTo(map);

  loadReports();

  // VatandaÅŸ haritaya tÄ±klayÄ±p bildirim yapabilir
  map.on("click", onMapClick);
}

/* ================= LOAD REPORTS ================= */
function loadReports() {
  fetch(API + "/reports", {
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token")
    }
  })
  .then(res => res.json())
  .then(data => {
    const role = localStorage.getItem("role");

    data.forEach(r => {
      const g = JSON.parse(r.geom);

      let popupContent = `
        <b>TÃ¼r:</b> ${r.type}<br>
        <b>Durum:</b> ${r.status}<br>
        <b>Ekip:</b> ${r.assigned_team || "AtanmadÄ±"}<br>
        <b>AÃ§Ä±klama:</b> ${r.description || "-"}<br>
      `;

      // ğŸ‘· Belediye Ã§alÄ±ÅŸanÄ±
      if (role === "worker") {
        popupContent += `
          <hr>
          <button onclick="updateStatus(${r.id}, 'tamir edilecek')">
            Tamir Edilecek
          </button>
          <button onclick="updateStatus(${r.id}, 'tamir edildi')">
            Tamir Edildi
          </button>
        `;
      }

      // ğŸ§‘â€ğŸ’¼ MÃ¼dÃ¼r
      if (role === "manager") {
        popupContent += `
          <hr>
          <button onclick="assignTeam(${r.id})">
            Ekip Ata
          </button>
        `;
      }

      L.marker([g.coordinates[1], g.coordinates[0]])
        .bindPopup(popupContent)
        .addTo(map);
    });
  });
}

/* ================= ADD NEW REPORT (USER) ================= */
function onMapClick(e) {
  const role = localStorage.getItem("role");
  if (role !== "user") return;

  const type = prompt("Sorun tÃ¼rÃ¼ (pothole / sidewalk)");
  if (!type) return;

  const description = prompt("AÃ§Ä±klama (isteÄŸe baÄŸlÄ±)");

  // ğŸ“ AnÄ±nda marker
  const marker = L.marker(e.latlng)
    .bindPopup("<b>Kaydediliyor...</b>")
    .addTo(map);

  fetch(API + "/reports", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.getItem("token")
    },
    body: JSON.stringify({
      type,
      description,
      lat: e.latlng.lat,
      lng: e.latlng.lng
    })
  }).then(() => {
    marker.setPopupContent(`
      <b>${type}</b><br>
      Durum: pending
    `);
  });
}

/* ================= UPDATE STATUS (WORKER) ================= */
function updateStatus(id, status) {
  fetch(API + `/reports/${id}/status`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.getItem("token")
    },
    body: JSON.stringify({ status })
  }).then(() => location.reload());
}

/* ================= ASSIGN TEAM (MANAGER) ================= */
function assignTeam(id) {
  const team = prompt("Ekip adÄ± giriniz");
  if (!team) return;

  fetch(API + `/reports/${id}/assign`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + localStorage.getItem("token")
    },
    body: JSON.stringify({ team })
  }).then(() => location.reload());
}
</script>

</body>
</html>
